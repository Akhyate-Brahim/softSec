#include <stdio.h>
#include <openssl/bn.h>

#define NBITS 256

void printBN(char *msg, BIGNUM * a)
{
   /* Use BN_bn2hex(a) for hex string
    * Use BN_bn2dec(a) for decimal string */
   char * number_str = BN_bn2hex(a);
   printf("%s %s\n", msg, number_str);
   OPENSSL_free(number_str);
}

int main(){
    BN_CTX *ctx = BN_CTX_new();

    BIGNUM *n = BN_new();
    BIGNUM *e = BN_new();
    BIGNUM *M = BN_new();
    BIGNUM *d = BN_new();
    BIGNUM *c = BN_new();
    BIGNUM *res = BN_new();

    BN_hex2bn(&n, "DCBFFE3E51F62E09CE7032E2677A78946A849DC4CDDE3A4D0CB81629242FB1A5");
    BN_hex2bn(&e,"010001");
    BN_hex2bn(&M, "4120746f702073656372657421");
    BN_hex2bn(&d, "74D806F9F3A62BAE331FFE3F0A68AFE35B3D2E4794148AACBC26AA381CD7D30D");

    // compute ciphertext
    BN_mod_exp(c, M, e, n, ctx);

    printBN("the computed ciphertext hex : ", c);

    BN_hex2bn(&c, "8C0F971DF2F3672B28811407E2DABBE1DA0FEBBBDFC7DCB67396567EA1E2493F");

    // decryption of c
    BN_mod_exp(res, c, d, n, ctx);
    printBN("the decrypted cipher hex : ", res);

    // signing a message
    printf("the message is : I owe you $3000.\n");
    BN_hex2bn(&M, "49206f776520796f752024333030302e");
    BIGNUM *s = BN_new();
    BN_mod_exp(s, M, d, n, ctx);
    printBN("the signature is : ", s);

    printf("\nthe message is : I owe you $2000.\n");
    BN_hex2bn(&M, "49206f776520796f752024323030302e");
    BN_mod_exp(s, M, d, n, ctx);
    printBN("the signature is : ", s);

    // verifying a signature
    BN_hex2bn(&n, "AE1CD4DC432798D933779FBD46C6E1247F0CF1233595113AA51B450F18116115");
    BN_hex2bn(&e,"010001");
    BN_hex2bn(&M, "4c61756e63682061206d697373696c652e");
    BN_hex2bn(&s, "643D6F34902D9C7EC90CB0B2BCA36C47FA37165C0005CAB026C0542CBDB6802F");

    BIGNUM *expected_message = BN_new();

    BN_mod_exp(expected_message, s,e,n,ctx);

    printBN("the message extracted using the signature : ",expected_message);
    printf(&M==&expected_message);

    // extracted modulus and exponent
    BN_hex2bn(&n, "C14BB3654770BCDD4F58DBEC9CEDC366E51F311354AD4A66461F2C0AEC6407E52EDCDCB90A20EDDFE3C4D09E9AA97A1D8288E51156DB1E9F58C251E72C340D2ED292E156CBF1795FB3BB87CA25037B9A52416610604F571349F0E8376783DFE7D34B674C2251A6DF0E9910ED57517426E27DC7CA622E131B7F238825536FC13458008B84FFF8BEA75849227B96ADA2889B15BCA07CDFE951A8D5B0ED37E236B4824B62B5499AECC767D6E33EF5E3D6125E44F1BF71427D58840380B18101FAF9CA32BBB48E278727C52B74D4A8D697DEC364F9CACE53A256BC78178E490329AEFB494FA415B9CEF25C19576D6B79A72BA2272013B5D03D40D321300793EA99F5");
    BN_hex2bn(&e, "65537");

    // extracting the signature
    BN_hex2bn(&s, "8032CE5E0BDD6E5A0D0AAFE1D684CBC08EFA8570EDDA5DB30CF72B7540FE850AFAF33178B7704B1A8958BA80BDF36B1DE97ECF0BBA589C59D490D3FD6CFDD0986DB771825BCF6D0B5A09D07BDEC443D82AA4DE9E41265FBB8F99CBDDAEE1A86F9F87FE74B71F1B20ABB14FC6F5675D5D9B3CE9FF69F7616CD6D9F3FD36C6AB038876D24B2E7586E3FCD8557D26C21177DF3E02B67CF3AB7B7A86366FB8F7D89371CF86DF7330FA7BABED2A59C842843B11171A52F3C90E147DA25B7267BA71ED574766C5B8024A65345E8BD02A3C209C51994CE7529EF76B112B0D927E1DE88AEB36164387EA2A63BF753FEBDEC403BB0A3CF730EFEBAF4CFC8B3610733EF3A4");

    // hash of the certificate
    BIGNUM *hash = BN_new();
    BN_hex2bn(&hash, "BBC2A75949C896BD66DB4E636AAB8B2CBAA970BC8302D8D02C99104AB04F4DD6");
    BN_mod_exp(expected_message, s,e,n,ctx);
    printf("\noriginal hash : BBC2A75949C896BD66DB4E636AAB8B2CBAA970BC8302D8D02C99104AB04F4DD6\n");
    printBN("hash generated through verification : ",expected_message);
}

